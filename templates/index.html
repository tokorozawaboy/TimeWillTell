<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeWillTell</title>
    <link rel="stylesheet" href="https://unpkg.com/chota@0.9.0/dist/chota.min.css">
    <link rel="icon" href="{{ url_for('static', filename='image/icon.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='image/icon.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Amazon Ember', 'Roboto', sans-serif;
            background-color: #141414;
            color: #f5f5f5;
            line-height: 1.5;
        }

        body {
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: none;
            width: 100%;
            margin: 0 auto;
            background-color: #141414;
            padding: 10px;
            border-radius: 4px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow: auto;
        }

        h1 {
            font-size: 2.0em;
            font-weight: 500;
            color: #fff;
            border-bottom: 1px solid #222;
            padding-bottom: 10px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: nowrap;
            padding: 15px;
            border-radius: 4px;
            background-color: #222;
            flex-shrink: 0;
            overflow-x: auto;
        }

        .header-controls label {
            color: #ccc;
            font-size: 0.9em;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .header-controls input,
        .header-controls select {
            border: 1px solid #333;
            padding: 8px;
            border-radius: 4px;
            background-color: #333;
            color: #f5f5f5;
            font-size: 0.9em;
            flex-grow: 1;
        }

        .header-controls button {
            background-color: #0071eb;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .header-controls button:hover {
            background-color: #005ecb;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: row;
            gap: 20px;
        }

        .left-panel {
            flex: 0 0 33%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            background-color: #222;
            border-radius: 4px;
            padding: 15px;
            border: 1px solid #333;
        }

        .race-list-container {
            background-color: #222;
            border-radius: 4px;
            padding: 15px;
            border: 1px solid #333;
            max-height: 200px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .race-list-container p {
            color: #ccc;
            font-weight: 500;
            margin-top: 0;
            font-size: 0.9em;
        }

        .race-item {
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 5px;
            transition: background-color 0.2s;
            font-size: 0.9em;
        }

        .race-item:hover {
            background-color: #333;
        }

        .race-item.selected {
            background-color: #0071eb;
            color: #fff;
            font-weight: bold;
        }

        #raceTableContainer {
            background-color: #222;
            border-radius: 4px;
            padding: 15px;
            border: 1px solid #333;
            max-height: 550px;
            flex-grow: 0;
            overflow-y: auto;
        }

        #raceTableContainer h2 {
            margin-bottom: 10px;
        }

        #updateOddsButton {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        #updateOddsButton:hover {
            background-color: #555;
        }

        #raceTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        #raceTable thead th {
            background-color: #333;
            color: #ccc;
            padding: 10px 15px;
            text-align: left;
            white-space: nowrap;
            font-weight: 500;
            border-bottom: 1px solid #555;
        }

        #raceTable tbody tr {
            transition: background-color 0.2s;
        }

        #raceTable tbody tr:nth-child(even) {
            background-color: #1e1e1e;
        }

        #raceTable tbody tr:hover {
            background-color: #333;
        }

        #raceTable tbody td {
            padding: 8px 15px;
            border-bottom: 1px solid #333;
            white-space: nowrap;
        }

        #raceTable tbody tr.highlight {
            background-color: #003d80 !important;
            border-left: 3px solid #0071eb;
        }

        #raceTable tbody td:nth-child(3) {
            cursor: pointer;
            color: #0071eb;
            text-decoration: none;
        }

        #raceTable tbody td:nth-child(3):hover {
            text-decoration: underline;
        }

        .graph-area {
            flex-grow: 1;
        }

        #corrected9MTimeGraphContainer,
        #correctedTimeGraphContainer {
            height: 400px;
            min-height: unset;
            margin-bottom: 20px;
            overflow: hidden;
        }

        #corrected9MTimeGraphContainer canvas,
        #correctedTimeGraphContainer canvas {
            height: 400px; /* !important を削除 */
            width: 100%; /* !important を削除 */
            margin-bottom: 20px;
        }

        .graph-area .graph-container {
            padding: 15px 0;
            border-bottom: 1px solid #333;
        }

        .graph-area .graph-container:last-child {
            border-bottom: none;
        }

        .graph-controls-group {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
            gap: 10px;
        }

        .graph-controls-group button {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .graph-controls-group button:hover {
            background-color: #555;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 5px;
            }

            .main-content {
                flex-direction: column;
                gap: 10px;
            }

            .left-panel,
            .right-panel {
                flex: auto;
                width: 100%;
                gap: 10px;
                padding: 10px;
                overflow-y: visible;
            }

            .header-controls {
                flex-wrap: nowrap;
                overflow-x: auto;
                padding: 10px;
                gap: 5px;
            }
            
            .header-controls input,
            .header-controls select,
            .header-controls button {
                font-size: 0.8em;
                padding: 6px;
            }

            .header-controls label {
                font-size: 0.8em;
            }

            .race-list-container {
                max-height: 150px;
                padding: 10px;
            }

            #raceTableContainer {
                padding: 10px;
                max-height: 250px;
                overflow-y: auto;
            }
            
            #raceTableContainer h2 {
                font-size: 1.2em;
            }

            #raceTable {
                width: 100%;
                min-width: 600px;
            }

            #raceTable thead th,
            #raceTable tbody td {
                white-space: nowrap;
            }

            #raceTable tbody td:nth-child(3):hover {
                text-decoration: underline;
            }

            #corrected9MTimeGraphContainer,
            #correctedTimeGraphContainer {
                height: 400px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@latest"></script>
</head>

<body>
    <div class="container">
        <h1><img src="{{ url_for('static', filename='image/icon.png') }}" alt="" width="30" height="30"> TimeWillTell</h1>
        <div class="main-content">
            <div class="left-panel">
                <div class="header-controls">
                    <label for="dateInput">日付:</label>
                    <input type="date" id="dateInput">
                    <label for="venueSelect">場所:</label>
                    <select id="venueSelect"></select>
                    <button onclick="fetchRaces()">レース取得</button>
                </div>
                <div class="race-list-container">
                    <p>レース一覧:</p>
                    <div id="raceList"></div>
                </div>
                <div id="raceTableContainer">
                    <h2>出馬表</h2>
                    <button id="updateOddsButton" class="button-small">オッズ更新</button>
                    <div style="overflow-x:auto;">
                        <table id="raceTable" class="full-width">
                            <thead>
                                <tr>
                                    <th>枠番</th>
                                    <th>馬番</th>
                                    <th>馬名</th>
                                    <th>性別</th>
                                    <th>年齢</th>
                                    <th>斤量</th>
                                    <th>騎手</th>
                                    <th>調教師</th>
                                    <th>人気</th>
                                    <th>オッズ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="graph-area">
                    <div id="corrected9MTimeGraphContainer" class="graph-container">
                        <h4>タイム指数グラフ</h4>
                        <div class="graph-controls-group">
                            <div class="graph-controls">
                                <button onclick="toggleAllLines(corrected9MTimeChart, true)">全表示</button>
                                <button onclick="toggleAllLines(corrected9MTimeChart, false)">全非表示</button>
                            </div>
                        </div>
                        <canvas id="corrected9MTimeChart"></canvas>
                    </div>

                    <div id="correctedTimeGraphContainer" class="graph-container">
                        <h4>クラス別タイム指数グラフ</h4>
                        <div class="graph-controls-group">
                            <div class="graph-controls">
                                <button onclick="toggleAllLines(correctedTimeChart, true)">全表示</button>
                                <button onclick="toggleAllLines(correctedTimeChart, false)">全非表示</button>
                            </div>
                        </div>
                        <canvas id="correctedTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let dateInput, venueSelect, raceListDiv, raceTableBody, correctedTimeChartCanvas, corrected9MTimeChartCanvas,
            updateOddsButton;

        let correctedTimeChart = null, corrected9MTimeChart = null;
        const availableVenues = ['東京', '京都', '阪神', '中山', '中京', '小倉', '札幌', '函館', '新潟', '福島',];
        let currentSelectedRace = { date: null, venue: null, raceNum: null, fullRaceId: null };

        function getLineChartOptions(titleText, annotations = []) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: titleText, font: { size: 14 } },
                    legend: {
                        labels: { font: { size: 10 }, boxWidth: 15, padding: 8 }
                    },
                    zoom: {
                        pan: { enabled: false },
                    },
                    annotation: {
                        annotations: annotations
                    }
                },
                scales: {
                    x: { type: 'time', time: { unit: 'month', tooltipFormat: 'YYYY/MM/DD', displayFormats: { month: 'YYYY/MM' } }, title: { display: true, text: '日付' } },
                    y: { title: { display: true, text: '能力値' } }
                }
            };
        }

        function toggleAllLines(chart, show) {
            chart.data.datasets.forEach((ds, i) => chart.getDatasetMeta(i).hidden = !show);
            chart.update();
        }

        async function fetchRaces() {
            const selectedDate = dateInput.value;
            const selectedVenue = venueSelect.value;
            try {
                const response = await fetch(`/api/races/${selectedDate}/${selectedVenue}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const races = await response.json();
                raceListDiv.innerHTML = '';
                if (races.length === 0) {
                    raceListDiv.textContent = '該当するレースがありませんでした。';
                    return;
                }
                races.forEach(race => {
                    const raceItem = document.createElement('div');
                    raceItem.className = 'race-item';
                    const classText = race['クラス名'] ? `(${race['クラス名']}クラス) ` : '';
                    const TrackAndDistanceText = race['距離'] ? `(${race['距離']}m)` : '';


                    raceItem.textContent = `${race['Ｒ']}R ${race['レース名']} ${classText}${TrackAndDistanceText}`;
                    raceItem.onclick = () => selectRace(selectedDate, selectedVenue, race['Ｒ'], raceItem);
                    raceListDiv.appendChild(raceItem);
                });
            } catch (error) {
                console.error('レース情報取得失敗:', error);
                Swal.fire('エラー', 'レース情報の取得に失敗しました。', 'error');
            }
        }

        async function selectRace(dateStr, venue, raceNum, selectedRaceItem) {
            document.querySelectorAll('.race-item.selected').forEach(item => item.classList.remove('selected'));
            selectedRaceItem.classList.add('selected');
            currentSelectedRace = { date: dateStr, venue: venue, raceNum: raceNum };
            Swal.fire({ title: '読み込み中...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const response = await fetch(`/api/race_card/${dateStr}/${venue}/${raceNum}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const raceCardData = await response.json();

                let benchmarkData = {};
                if (raceCardData.length > 0) {
                    const currentRaceData = raceCardData[0];
                    const currentRaceClass = currentRaceData['クラス名'] || null;
                    const currentRaceVenue = currentRaceData['場所'] || null;
                    const currentTrackAndDistance = currentRaceData['距離'] || null;

                    if (currentRaceVenue && currentTrackAndDistance && currentRaceClass) {
                        const benchmarkResponse = await fetch(`/api/benchmark_times/${currentRaceVenue}/${currentTrackAndDistance}/${currentRaceClass}`);
                        if (benchmarkResponse.ok) {
                            benchmarkData = await benchmarkResponse.json();
                        }
                    }
                }

                currentSelectedRace.fullRaceId = (raceCardData.length > 0 && raceCardData[0]['race_id']) ? raceCardData[0]['race_id'] : null;
                updateOddsButton.disabled = !currentSelectedRace.fullRaceId;
                displayRaceTable(raceCardData);
                await createAllAbilityCharts(raceCardData, benchmarkData);
                Swal.close();
            } catch (error) {
                console.error('出馬表情報取得失敗:', error);
                Swal.fire('エラー', '出馬表情報の取得に失敗しました。', 'error');
            }
        }

        function displayRaceTable(raceCardData) {
            raceTableBody.innerHTML = '';
            if (raceCardData.length === 0) {
                const row = raceTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 10;
                cell.textContent = '出走馬情報がありません。';
                return;
            }
            const headers = ['枠番', '馬番', '馬名', '性別', '年齢', '斤量', '騎手', '調教師', '人気', 'オッズ'];
            raceCardData.forEach(horse => {
                const row = raceTableBody.insertRow();
                const cleanedHorseName = horse['馬名'] ? horse['馬名'].trim() : null;
                row.dataset.horseName = cleanedHorseName;
                
                headers.forEach(header => {
                    const cell = row.insertCell();
                    cell.textContent = horse[header] ?? 'N/A';
                    cell.setAttribute('data-label', header);
                    if (header === '馬名' && cleanedHorseName) {
                        cell.style.cursor = 'pointer';
                        cell.onclick = () => highlightHorseInChart(cleanedHorseName);
                    }
                });
            });
        }


        async function createAllAbilityCharts(raceCardHorses, benchmarkData = {}) {
            if (correctedTimeChart) correctedTimeChart.destroy();
            if (corrected9MTimeChart) corrected9MTimeChart.destroy();

            const datasets = { corrected: [], corrected9M: [] };
            for (const horse of raceCardHorses) {
                const cleanedHorseName = horse['馬名'] ? horse['馬名'].trim() : null;
                if (!cleanedHorseName) continue;
                try {
                    const response = await fetch(`/api/horse_past_data/${cleanedHorseName}`);
                    if (!response.ok) continue;
                    const responseData = await response.json();

                    const pastDataCorrected = responseData.past_races
                        .filter(d => d['補正'] !== null && d['補正'] !== undefined)
                        .sort((a, b) => new Date(a['日付']) - new Date(b['日付']));

                    const pastDataCorrected9M = responseData.past_races
                        .filter(d => d['補9'] !== null && d['補9'] !== undefined)
                        .sort((a, b) => new Date(a['日付']) - new Date(b['日付']));

                    if (pastDataCorrected.length > 0) {
                        const randomColor = getRandomColor();
                        const commonConfig = { label: cleanedHorseName, borderColor: randomColor, backgroundColor: 'rgba(0,0,0,0)', borderWidth: 2, pointRadius: 4, horseName: cleanedHorseName, originalColor: randomColor };
                        datasets.corrected.push({ ...commonConfig, data: pastDataCorrected.map(d => ({ x: d['日付'], y: d['補正'], originalData: d })) });
                    }
                    if (pastDataCorrected9M.length > 0) {
                        const randomColor = getRandomColor();
                        const commonConfig = { label: cleanedHorseName, borderColor: randomColor, backgroundColor: 'rgba(0,0,0,0)', borderWidth: 2, pointRadius: 4, horseName: cleanedHorseName, originalColor: randomColor };
                        datasets.corrected9M.push({ ...commonConfig, borderDash: [5, 5], data: pastDataCorrected9M.map(d => ({ x: d['日付'], y: d['補9'], originalData: d })) });
                    }
                } catch (error) { console.error(`データ取得失敗: ${cleanedHorseName}`, error); }
            }

            const getAnnotations = (type) => {
                const annotations = [];
                const value = type === 'corrected' ? benchmarkData.avg_corrected_time : benchmarkData.avg_corrected9m_time;
                if (value !== null && value !== undefined && raceCardHorses.length > 0) {
                    const raceClass = raceCardHorses[0]['クラス名'] || 'N/A';
                    annotations.push({
                        type: 'line',
                        yMin: value,
                        yMax: value,
                        borderColor: type === 'corrected' ? 'rgba(255, 0, 0, 0.8)' : 'rgba(0, 0, 255, 0.8)',
                        borderWidth: 2,
                        borderDash: [6, 6],
                        label: {
                            content: `${raceClass} 好走平均`,
                            enabled: true,
                            position: 'start',
                            backgroundColor: 'rgba(0,0,0,0.6)',
                            font: { size: 10 }
                        }
                    });
                }
                return annotations;
            };

            correctedTimeChart = new Chart(correctedTimeChartCanvas, {
                type: 'line',
                data: { labels: [], datasets: datasets.corrected },
                options: getLineChartOptions('各馬のクラス別タイム指数推移', getAnnotations('corrected'))
            });

            corrected9MTimeChart = new Chart(corrected9MTimeChartCanvas, {
                type: 'line',
                data: { labels: [], datasets: datasets.corrected9M },
                options: getLineChartOptions('各馬のタイム指数推移', getAnnotations('corrected9m'))
            });

            addClickHandlerToChart(correctedTimeChart);
            addClickHandlerToChart(corrected9MTimeChart);
        }

        function toggleAllLines(chart, show) {
            chart.data.datasets.forEach((ds, i) => chart.getDatasetMeta(i).hidden = !show);
            chart.update();
        }

        async function highlightHorseInChart(horseName) {
            const cleanedHorseName = horseName ? horseName.trim() : null;

            [correctedTimeChart, corrected9MTimeChart].forEach(chart => {
                if (!chart) return;
                chart.data.datasets.forEach(ds => {
                    const isTarget = cleanedHorseName && ds.horseName === cleanedHorseName;

                    if (cleanedHorseName) {
                        ds.borderColor = isTarget ? ds.originalColor : ds.originalColor.replace(/rgba\((.*),([\d.]+)\)/, 'rgba($1, 0.3)');
                        ds.borderWidth = isTarget ? 4 : 2;
                        ds.pointRadius = isTarget ? 6 : 4;
                    } else {
                        ds.borderColor = ds.originalColor;
                        ds.borderWidth = 2;
                        ds.pointRadius = 4;
                    }
                });
                chart.update();
            });

            document.querySelectorAll('#raceTable tbody tr').forEach(row => {
                row.classList.toggle('highlight', row.dataset.horseName === cleanedHorseName);
            });
        }

        async function updateOdds() {
            if (!currentSelectedRace.fullRaceId) {
                Swal.fire('警告', 'レースが選択されていないか、レースIDが取得できません。', 'warning');
                return;
            }
            Swal.fire({ title: 'オッズを更新中...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const response = await fetch(`/api/race_card/${currentSelectedRace.date}/${currentSelectedRace.venue}/${currentSelectedRace.raceNum}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const updatedRaceCardData = await response.json();
                displayRaceTable(updatedRaceCardData);
                Swal.fire('更新完了', 'オッズが正常に更新されました。', 'success');
            } catch (error) {
                console.error('オッズ更新失敗:', error);
                Swal.fire('更新失敗', 'オッズの更新中にエラーが発生しました。', 'error');
            }
        }

        function getRandomColor(alpha = 1) {
            const r = Math.floor(Math.random() * 255);
            const g = Math.floor(Math.random() * 255);
            const b = Math.floor(Math.random() * 255);
            return `rgba(${r},${g},${b},${alpha})`;
        }

        function addClickHandlerToChart(chartInstance) {
            if (!chartInstance) return;
            chartInstance.canvas.onclick = (e) => {
                const elements = chartInstance.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                if (elements.length > 0) {
                    const { datasetIndex, index } = elements[0];
                    const dataset = chartInstance.data.datasets[datasetIndex];
                    const original = dataset.data[index]?.originalData;
                    if (original) {
                        Swal.fire({
                            title: dataset.horseName,
                            icon: 'info',
                            html: `<div style="text-align: left; display: inline-block;">
                                <strong>日付:</strong> ${moment(original['日付']).format('YYYY/MM/DD')}<br>
                                <strong>クラス:</strong> ${original['クラス名'] || 'N/A'}<br>
                                <strong>タイム指数:</strong> ${original['補9'] || 'N/A'}<br>
                                <strong>クラス別指数:</strong> ${original['補正'] || 'N/A'}<br>
                                <strong>着順:</strong> ${original['着順'] || 'N/A'}<br>
                                <strong>場所:</strong> ${original['場所'] || 'N/A'}<br>
                                <strong>距離:</strong> ${original['トラック種別'] || ''}${original['距離'] ? original['距離'] + 'm' : ''}<br>
                                <strong>馬場状態:</strong> ${original['馬場状態'] || 'N/A'}
                                </div>`,
                            confirmButtonText: '閉じる'
                        });
                    }
                }
            };
        }
        
        // debounce関数の定義
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            dateInput = document.getElementById('dateInput');
            venueSelect = document.getElementById('venueSelect');
            raceListDiv = document.getElementById('raceList');
            raceTableBody = document.querySelector('#raceTable tbody');
            correctedTimeChartCanvas = document.getElementById('correctedTimeChart');
            corrected9MTimeChartCanvas = document.getElementById('corrected9MTimeChart');
            updateOddsButton = document.getElementById('updateOddsButton');

            availableVenues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue;
                option.textContent = venue;
                venueSelect.appendChild(option);
            });
            venueSelect.value = '東京';
            dateInput.value = new Date().toISOString().split('T')[0];

            correctedTimeChart = new Chart(correctedTimeChartCanvas, { type: 'line', data: { labels: [], datasets: [] }, options: getLineChartOptions('各馬のクラス別タイム指数推移') });
            corrected9MTimeChart = new Chart(corrected9MTimeChartCanvas, { type: 'line', data: { labels: [], datasets: [] }, options: getLineChartOptions('各馬のタイム指数推移') });
            addClickHandlerToChart(correctedTimeChart);
            addClickHandlerToChart(corrected9MTimeChart);

            updateOddsButton.addEventListener('click', updateOdds);
            updateOddsButton.disabled = true;

            fetchRaces();

            // debounce を使ったリサイズイベントリスナー
            const debouncedResize = debounce(() => {
                if (correctedTimeChart) {
                    correctedTimeChart.resize();
                }
                if (corrected9MTimeChart) {
                    corrected9MTimeChart.resize();
                }
            }, 200); // 200ms後に実行
            window.addEventListener('resize', debouncedResize);
        });
    </script>
</body>

</html>